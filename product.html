<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Details | DeLux Mart</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f4f4f4;
  color: #333;
}

header {
  background-color: #222;
  color: white;
  display: flex;
  justify-content: space-between;
  padding: 1rem 2rem;
  align-items: center;
}
    .hero {
  background: url('./images/aboutbackground.jpg') center center / cover no-repeat;
  text-align: center;
  color: black;
  padding: 6rem 2rem;
}
    .logo {
  font-size: 1.5rem;
  font-weight: bold;
  position: absolute;
  left: 90px;
}
    nav ul {
  display: flex;
  list-style: none;
  gap: 1.5rem;
}

nav a {
  color: white;
  text-decoration: none;
  transition: color 0.3s;
}

nav a:hover {
  color: #f39c12;
}
    .product-details { max-width: 1000px; margin: 2rem auto; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; background: #fff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .product-image img { width: 100%; border-radius: 8px; }
    .product-info h2 { margin: 0 0 0.5rem; }
    .product-meta { color: #555; margin: 0.5rem 0 1rem; }
    .price { font-size: 1.4rem; font-weight: 600; margin: 1rem 0; }
    .qty { display: flex; align-items: center; gap: 0.5rem; margin: 1rem 0; }
    .qty button { width: 32px; height: 32px; border: none; border-radius: 5px; background: #007bff; color: #fff; cursor: pointer; }
    .qty input { width: 60px; text-align: center; padding: 0.3rem; border: 1px solid #ddd; border-radius: 5px; }
    .add-btn { background: #28a745; color: #fff; border: none; padding: 0.8rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 1rem; }
  </style>
  </head>
<body>
  <header>
    <img src="/images/Logo1.png" height="45px" width="50px">
    <div class="logo">DeLux Mart</div>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/products" class="active">Products</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/cart" id="cartLink">Cart</a></li>
        <li><a href="/orders" id="ordersLink">Orders</a></li>
        <li><a href="/loginpage" id="loginLink">Login</a></li>
        <li><a href="#" id="logoutLink" style="display: none;">Logout</a></li>
      </ul>
    </nav>
  </header>

  <section class="product-details" id="productDetails">
    <div class="product-image">
      <img id="pImage" alt="Product" />
    </div>
    <div class="product-info">
      <h2 id="pName"></h2>
      <p class="product-meta"><span id="pCategory"></span></p>
      <p id="pDesc"></p>
      <p class="price" id="pPrice"></p>
      <div class="qty">
        <button id="dec">-</button>
        <input type="number" id="quantity" value="1" min="1" />
        <button id="inc">+</button>
      </div>
      <button class="add-btn" id="addToCart">Add to Cart</button>
    </div>
  </section>

  <section style="max-width: 1000px; margin: 1rem auto; background: #fff; padding: 1rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3>User Reviews</h3>
    <div id="commentsList" style="margin-bottom:1rem;"></div>
    <div>
      <textarea id="commentInput" rows="3" placeholder="Write a comment..." style="width:100%; padding:0.5rem;"></textarea>
      <button id="submitComment" class="add-btn" style="margin-top:0.5rem;">Add Comment</button>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 DeLux Mart. All rights reserved.</p>
  </footer>

  <script>
    function updateNavigation() {
      const userEmail = localStorage.getItem('userEmail');
      const loginLink = document.getElementById('loginLink');
      const logoutLink = document.getElementById('logoutLink');
      if (userEmail) { loginLink.style.display = 'none'; logoutLink.style.display = 'inline'; } else { loginLink.style.display = 'inline'; logoutLink.style.display = 'none'; }
    }
    document.getElementById('logoutLink').addEventListener('click', function(e) { e.preventDefault(); localStorage.removeItem('userEmail'); localStorage.removeItem('userName'); updateNavigation(); window.location.href = '/'; });

    const params = window.location.pathname.split('/');
    const productId = params[params.length - 1];
    let sellerEmail = '';
    let productName = '';
    let productPrice = '';
    let productImage = '';

    async function loadProduct() {
      try {
        const res = await fetch(`/api/products/${productId}`);
        const data = await res.json();
        if (!data.success) { document.getElementById('productDetails').innerHTML = '<p>Product not found.</p>'; return; }
        const p = data.product;
        productName = p.name;
        productPrice = p.price;
        productImage = p.image;
        sellerEmail = p.email;
        document.getElementById('pImage').src = p.image;
        document.getElementById('pName').textContent = p.name;
        document.getElementById('pCategory').textContent = p.category ? ('Category: ' + p.category) : '';
        document.getElementById('pDesc').textContent = p.description || '';
        document.getElementById('pPrice').textContent = '$' + parseFloat(p.price).toFixed(2);
      } catch (e) {
        document.getElementById('productDetails').innerHTML = '<p>Error loading product.</p>';
      }
    }

    async function loadComments(){
      try {
        const res = await fetch(`/get-comments/${productId}`);
        const data = await res.json();
        const list = document.getElementById('commentsList');
        if (!data.success || data.comments.length === 0){ list.innerHTML = '<p>No comments yet.</p>'; return; }
        list.innerHTML = data.comments.map(c => `<div style="border-bottom:1px solid #eee; padding:0.5rem 0;"><strong>${c.email}</strong><br>${c.comment}<br><small>${new Date(c.createdAt).toLocaleString()}</small></div>`).join('');
      } catch(e){ document.getElementById('commentsList').innerHTML = '<p>Error loading comments.</p>'; }
    }

    document.getElementById('inc').addEventListener('click', function(){ const q = document.getElementById('quantity'); q.value = parseInt(q.value || '1') + 1; });
    document.getElementById('dec').addEventListener('click', function(){ const q = document.getElementById('quantity'); const v = Math.max(1, parseInt(q.value || '1') - 1); q.value = v; });

    document.getElementById('addToCart').addEventListener('click', async function(){
      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail) { alert('Please login first to add items to cart'); window.location.href = '/loginpage'; return; }
      const quantity = parseInt(document.getElementById('quantity').value || '1');
      try {
        const response = await fetch('/add-to-cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: userEmail,
            productId: productId,
            productName: productName,
            productPrice: productPrice,
            productImage: productImage,
            quantity: quantity,
            sellerEmail: sellerEmail
          })
        });
        const data = await response.json();
        if (data.success) { alert('Added to cart!'); this.textContent = 'Added'; this.disabled = true; }
        else { alert(data.message); }
      } catch (err) { alert('Error adding to cart.'); }
    });

    document.getElementById('submitComment').addEventListener('click', async function(){
      const userEmail = localStorage.getItem('userEmail');
      if (!userEmail){ alert('Please login first to comment'); window.location.href = '/loginpage'; return; }
      const comment = document.getElementById('commentInput').value.trim();
      if (!comment){ alert('Please enter a comment'); return; }
      try{
        const res = await fetch('/add-comment', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: userEmail, productId: productId, comment }) });
        const data = await res.json();
        if (data.success){ document.getElementById('commentInput').value=''; await loadComments(); }
        else { alert(data.message); }
      }catch(e){ alert('Error adding comment'); }
    });

    document.addEventListener('DOMContentLoaded', function(){ updateNavigation(); loadProduct(); loadComments(); });
  </script>
</body>
</html>
